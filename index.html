<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="dark">
<meta name="theme-color" content="#0b1a27">
<title>CGA G√ºvenlik Sistemleri - Giri≈ü Paneli</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">

<style>
:root {
  color-scheme: dark;
  --cga-bg-main: #0b1a27;
  --cga-bg-secondary: #1a2b3f;
  --cga-gold: #f1c40f;
  --cga-green: #2ecc71;
  --cga-green-dark: #27ae60;
  --cga-text-main: #ecf0f1;
  --cga-card-bg: rgba(255,255,255,0.06);
  --cga-border-soft: rgba(255,255,255,0.12);
}

html, body {
  margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
  font-family: 'Montserrat', sans-serif;
  display: flex; justify-content: center; align-items: center;
  background: radial-gradient(circle at top, rgba(241,196,15,0.08), transparent 40%),
              linear-gradient(135deg, var(--cga-bg-main), var(--cga-bg-secondary));
  color: var(--cga-text-main);
    -webkit-touch-callout: none;

}

.container {
  width: 380px;
  padding: 40px 30px 70px;
  border-radius: 26px;
  background: var(--cga-card-bg);
  backdrop-filter: blur(22px);
  box-shadow: 0 0 0 1px var(--cga-border-soft), 0 20px 50px rgba(0,0,0,0.7);
  text-align: center;
  transform: translateY(-20px);
}

h1 { font-size:26px; font-weight:800; color: var(--cga-gold); margin-bottom:8px; cursor:pointer; }

.site-name{
  display:none; font-size:28px; font-weight:800; letter-spacing:1px; margin:1px 0 18px;
  color:#2ecc71; text-shadow:0 0 10px rgba(46,204,113,0.6),0 0 25px rgba(46,204,113,0.4);
}

.input-group { display:none; flex-direction:column; text-align:left; margin-bottom:28px; }
.input-group.active { display:flex; }

input[type="text"], input[type="password"] { width:100%; padding:12px; margin:8px 0; border-radius:12px; border:none; background: rgba(255,255,255,0.1); color:white; font-size:14px;}
input::placeholder { color: rgba(236,240,241,0.6); }

.remember {display:flex; align-items:center; gap:8px; font-size:14px; margin-top:8px;}
.remember input[type="checkbox"] { cursor:pointer; }
.remember label { cursor:pointer; color:#fff; }

.loginBtn {
  width:100%; padding:13px; border:none; border-radius:16px; font-weight:700; font-size:16px; cursor:pointer; margin-bottom:24px;
  background: linear-gradient(90deg,var(--cga-green-dark),var(--cga-green));
  box-shadow:0 6px 20px rgba(46,204,113,0.45); transition:0.25s;
}
.loginBtn:hover { background: linear-gradient(90deg,#2ecc71,#27ae60); transform:translateY(-2px); }

.message {
  margin-top:15px;
  margin-bottom:40px; /* üëà YAZILARI YUKARI ALIR */
  color:#e74c3c;
  font-weight:600;
  text-align:center;
  min-height:20px;
}


.cga-logo { width:450px; max-width:80%; margin:20px auto 0; }
.corner-bottom{ position: fixed; bottom:12px; right:14px; font-size:11px; color: rgba(189,195,199,0.7); user-select:none; pointer-events:none; }
.corner-top{ position: fixed; top:10px; right:14px; font-size:10px; color: rgba(189,195,199,0.7); user-select:none; pointer-events:none; }

.securityText{
  font-size:16px; font-weight:700; color: var(--cga-gold); margin-bottom:20px; cursor:pointer; text-align:center;
  padding:8px 0; letter-spacing:0.5px; transition:0.25s;
}
.securityText:hover{ transform: scale(1.06); color:#f7d35e; }

#qr-reader {
  width: 95vw;
  height: 70vh;
  max-width: 600px;
  max-height: 600px;
  margin: auto;
  border-radius: 12px;
  background: #000;
}

.modal-content {
  max-width: 95%;
}
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.modal.hidden {
  display: none;
}

.modal-box {
  background: #1e1e1e;
  padding: 20px;
  border-radius: 12px;
  width: 85%;
  max-width: 320px;
  text-align: center;
  color: #fff;
}

.modal-actions {
  display: flex;
  gap: 12px;
  margin-top: 20px;
}

.modal-actions button {
  flex: 1;
  padding: 10px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
}

#cancelDisconnect {
  background: #555;
  color: #fff;
}

#confirmDisconnect {
  background: #e74c3c;
  color: #fff;
}
.disconnect-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.disconnect-modal.hidden {
  display: none;
}
/* ‚ùå Sayfa genelinde se√ßim kapalƒ± */
* {
  -webkit-user-select: none;
  -ms-user-select: none;
  user-select: none;
}
</style>
</head>
<body>

<div class="container">
  <img src="logo.png" class="cga-logo" alt="CGA Logo">

  <div id="qrSection" style="margin:20px 0; text-align:center;">
    <button id="startQR" class="loginBtn">üì∑ QR Kodu Okut</button>
	<div id="siteName" class="site-name"></div>
    <div id="qrMessage" style="margin-top:10px; color:#f1c40f;"></div>
  </div>

<div id="qrModal" class="modal hidden">
    <div class="modal-content">
      <div id="qr-reader"></div>
      <button id="closeQRModal" class="loginBtn">Kapat</button>
    </div>
  </div>

  <div class="securityText" id="securityBtn">üîê G√ºvenlik Giri≈üi</div>

  <div id="securityGroup" class="input-group active">
    <input type="text" id="secUsername" placeholder="Kullanƒ±cƒ± Adƒ±">
    <input type="password" id="secPassword" placeholder="≈ûifre">
    <div class="remember">
      <input type="checkbox" id="secRemember">
      <label for="secRemember">Kullanƒ±cƒ±yƒ± hatƒ±rla</label>
    </div>
    <button class="loginBtn" id="secLoginBtn">Giri≈ü Yap</button>
  </div>

  <div class="message" id="message"></div>
</div>

<div class="corner-bottom">¬© 2025 CGA G√ºvenlik Sistemleri</div>
<div class="corner-top">v1.0.0</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

// MERKEZ FIREBASE
const merkezConfig = {
  apiKey: "AIzaSyBWu01alJKdnEvhs_bumDCxgGO9m-BX5Y0",
  authDomain: "merkezprojecga.firebaseapp.com",
  databaseURL: "https://merkezprojecga-default-rtdb.firebaseio.com",
  projectId: "merkezprojecga",
  storageBucket: "merkezprojecga.firebasestorage.app",
  messagingSenderId: "4183440370",
  appId: "1:4183440370:web:c83e65bbc6c1724a3a896b",
  measurementId: "G-YCSTH0NW94"
};
const merkezApp = getApps().find(a => a.name === "[DEFAULT]") || initializeApp(merkezConfig);
const merkezDB = getDatabase(merkezApp);

// DOM
const siteNameEl = document.getElementById("siteName");
const securityBtn = document.getElementById("securityBtn");
const securityGroup = document.getElementById("securityGroup");
const msg = document.getElementById("message");
const secUsername = document.getElementById("secUsername");
const secPassword = document.getElementById("secPassword");
const secRemember = document.getElementById("secRemember");

// sayfa y√ºklenince kullanƒ±cƒ± bilgisi
window.addEventListener("load", ()=>{
  securityBtn.click();
  const secStored = JSON.parse(localStorage.getItem("securityUser"));
  if(secStored){ secUsername.value=secStored.username; secPassword.value=secStored.password; secRemember.checked=true; }
});
// üîÅ Sayfa yenilenince siteyi geri y√ºkle
const savedSiteID = localStorage.getItem("siteID");
const savedConfig = localStorage.getItem("siteConfig");


if (savedSiteID && savedConfig) {
  const siteConfig = JSON.parse(savedConfig);

  let siteApp = getApps().find(a => a.name === `siteApp-${savedSiteID}`);
  if (!siteApp) {
    siteApp = initializeApp(siteConfig, `siteApp-${savedSiteID}`);
  }

  const siteDB = getDatabase(siteApp);

  document.getElementById("startQR").style.display = "none";
  siteNameEl.style.display = "block";
  document.getElementById("qrMessage").textContent =
    "";

  loadSiteName(siteDB);
}

// B√ºy√ºk harf
[secUsername, secPassword].forEach(el=>{ el.addEventListener("input", ()=>{ el.value = el.value.toUpperCase(); }); });

// QR MODAL
// QR MODAL (FIX)
let qrReader = null;
const qrModal = document.getElementById("qrModal");
const closeQRModal = document.getElementById("closeQRModal");

closeQRModal.addEventListener("click", async () => {
  qrModal.style.display = "none";

  if (qrReader) {
    try {
      await qrReader.stop();
    } catch (e) {}
    qrReader = null;
  }

  document.getElementById("qr-reader").innerHTML = "";
});


// SITE CONFIG
async function loadSiteConfig(siteID){
  try{
    const snap = await get(child(ref(merkezDB), `sites/${siteID}/config`));
    if(!snap.exists()){ msg.textContent="Site config bulunamadƒ±!"; return null; }
    const siteConfig = snap.val();

    let siteApp = getApps().find(a=>a.name==`siteApp-${siteID}`);
    if(!siteApp) siteApp = initializeApp(siteConfig, `siteApp-${siteID}`);
    const siteDB = getDatabase(siteApp);

localStorage.setItem("siteID", siteID);
localStorage.setItem("siteConfig", JSON.stringify(siteConfig));

    document.getElementById("qrMessage").textContent = "Site ayarlarƒ± y√ºklendi, giri≈ü yapabilirsiniz!";
    await loadSiteName(siteDB);
	document.getElementById("startQR").style.display = "none";
siteNameEl.style.display = "block";
    return siteDB;
  }catch(e){ console.error(e); document.getElementById("qrMessage").textContent="QR y√ºklenirken hata!"; }
}

// ENTER ile login
document.addEventListener("keydown", e=>{
  if(e.key==="Enter" && securityGroup.classList.contains("active")) document.getElementById("secLoginBtn").click();
});

// LOGIN
async function loginUser(username,password,role){
  username=username.trim(); password=password.trim(); msg.textContent="";
  const siteConfig = sessionStorage.getItem("siteConfig") ? JSON.parse(sessionStorage.getItem("siteConfig")) : null;
  if(!siteConfig){ msg.textContent="L√ºtfen QR kodu okutunuz!"; return; }
  if(!username||!password){ msg.textContent="Kullanƒ±cƒ± adƒ± ve ≈üifre gerekli!"; return; }

  try{
    const siteId = sessionStorage.getItem("siteID");
    let app = getApps().find(a=>a.name==`siteApp-${siteId}`);
    if(!app) app=initializeApp(siteConfig,`siteApp-${siteId}`);
    const activeDB = getDatabase(app);

    const adminSnap = await get(child(ref(activeDB),'admin'));
    if(adminSnap.exists()){
      const adminUser = adminSnap.val();
      if(username===adminUser.username && password===adminUser.password){
        sessionStorage.setItem("currentUser", JSON.stringify({username,type:"admin"}));
        window.location.href="mod.html"; return;
      }
    }

    const userSnap = await get(child(ref(activeDB),'users/'+username));
    if(!userSnap.exists()){ msg.textContent="Kullanƒ±cƒ± bulunamadƒ±!"; return; }
    const user=userSnap.val();
    if(user.password!==password){ msg.textContent="≈ûifre hatalƒ±!"; return; }

    sessionStorage.setItem("currentUser", JSON.stringify({username:user.username,type:user.type}));
    if(role==="security"){
      if(secRemember.checked) localStorage.setItem("securityUser",JSON.stringify({username,password}));
      else localStorage.removeItem("securityUser");

      if(user.type==="company") window.location.href="sirket.html";
      else if(user.type==="security") window.location.href="guvenlik.html";
      else if(user.type==="admin") window.location.href="yetkili.html";
      else msg.textContent="Yetki hatalƒ±!";
    }

  }catch(err){ console.error(err); msg.textContent="Baƒülantƒ± hatasƒ±!"; }
}

document.getElementById("secLoginBtn").addEventListener("click", ()=>{
  loginUser(secUsername.value, secPassword.value,"security");
});

// SITE ADI
async function loadSiteName(db){
  try{
    const snap = await get(child(ref(db),"settings/siteName"));
    if(snap.exists()){
      const name=snap.val().trim();
      if(name!==""){ siteNameEl.textContent=name; siteNameEl.style.display="block"; }
    }
  }catch(e){ console.error("Site adƒ± y√ºklenemedi", e); }
}


document.getElementById("startQR").addEventListener("click", async () => {
  qrModal.style.display = "flex";

  // QR alanƒ±nƒ± SIFIRLA
  const qrDiv = document.getElementById("qr-reader");
  qrDiv.innerHTML = "";

  // YENƒ∞ instance (√áOK √ñNEMLƒ∞)
  qrReader = new Html5Qrcode("qr-reader");

  const qrBoxSize = Math.min(window.innerWidth * 0.8, 300);
  const cameraConfig = { facingMode: "environment" };

  // QR taramayƒ± ba≈ülat
  qrReader.start(
    cameraConfig,
    { fps: 10, qrbox: qrBoxSize },
 async (qrCodeMessage) => {
  try {
    await qrReader.stop();
  } catch(e) {}

  qrReader = null;
  qrModal.style.display = "none";

  await loadSiteConfig(qrCodeMessage);
  document.getElementById("qrMessage").textContent =
    "ƒ∞≈ülem Ba≈üarlƒ± ≈ûimdi Kullanƒ±cƒ± Adƒ± Ve ≈ûifrenizi Giriniz.!";
},

    (err) => {
      // Tarama sƒ±rasƒ±nda hatalar
      console.log("QR tarama hatasƒ±:", err);
    }
  ).catch(err => {
    alert("Kamera a√ßƒ±lamadƒ±: " + err);
    qrModal.style.display = "none";
  });
});
let pressTimer = null;

siteNameEl.addEventListener("mousedown", () => {
  pressTimer = setTimeout(() => {
    openDisconnectModal();
  }, 800);
});


siteNameEl.addEventListener("mouseup", () => clearTimeout(pressTimer));
siteNameEl.addEventListener("mouseleave", () => clearTimeout(pressTimer));

siteNameEl.addEventListener("touchstart", () => {
  pressTimer = setTimeout(() => {
    openDisconnectModal();
  }, 800);
});

siteNameEl.addEventListener("touchend", () => clearTimeout(pressTimer));
function disconnectProject() {
localStorage.removeItem("siteID");
localStorage.removeItem("siteConfig");
sessionStorage.removeItem("currentUser"); // kullanƒ±cƒ± oturumu ge√ßici kalsƒ±n


  siteNameEl.textContent = "";
  siteNameEl.style.display = "none";

  document.getElementById("startQR").style.display = "block";
  document.getElementById("qrMessage").textContent =
    "Proje baƒülantƒ±sƒ±ndan ayrƒ±ldƒ±nƒ±z.";

  msg.textContent = "";
}
const modal = document.getElementById("disconnectModal");
const cancelBtn = document.getElementById("cancelDisconnect");
const confirmBtn = document.getElementById("confirmDisconnect");

function openDisconnectModal() {
  modal.classList.remove("hidden");
}

function closeDisconnectModal() {
  modal.classList.add("hidden");
}

cancelBtn.onclick = closeDisconnectModal;
confirmBtn.onclick = () => {
  closeDisconnectModal();
  disconnectProject();
};
</script>
<!-- üîí DISCONNECT MODAL -->
<div id="disconnectModal" class="disconnect-modal hidden">
  <div class="modal-box">
    <p>Proje baƒülantƒ±sƒ±ndan ayrƒ±lmak istiyor musunuz?</p>
    <div class="modal-actions">
      <button id="cancelDisconnect">ƒ∞ptal</button>
      <button id="confirmDisconnect">Ayrƒ±l</button>
    </div>
  </div>
</div>

</body>
</html>

